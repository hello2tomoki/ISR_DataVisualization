CREATE   PROCEDURE [Stg_Rpt].[RM_Generate_Active_Risk_DAX] @Curr_Date VARCHAR(8),
                                                                  @Prev_Date VARCHAR(8) AS
BEGIN 


/*

Proc Author - Shiva Praneeth Palla
DAX  Author - Andrew Eales
Created Date - 04/25/2019

Exec Sandbox2.Stg_Rpt.RM_Generate_Active_Risk_DAX 20190329,20190322
Declare @Curr_Date varchar(8);
Declare @Prev_Date Varchar(8) ;
Set @Curr_Date = 20190329; 
Set @Prev_Date = 20190322; 
*/

    DECLARE @DAX_Query VARCHAR(MAX);
    DECLARE @DAX_Query2 VARCHAR(MAX);
    DECLARE @SQL_Query VARCHAR(MAX);
    DECLARE @Server_Name VARCHAR(50);
    SELECT @Server_Name = @@ServerName;
    SET @DAX_Query = 'Evaluate VAR vRiskDateKeyCurrent  ='+@Curr_Date+' VAR vRiskDateKeyPrevious ='+@Prev_Date+' VAR vRiskVersionKeyCurrent =  CALCULATE (  MAX ( Riskversion[RiskVersionKey] ),  Riskversion[RiskDateKey] = vRiskDateKeyCurrent  )  VAR vRiskVersionKeyPrevious =  CALCULATE (  MAX ( Riskversion[RiskVersionKey] ),  Riskversion[RiskDateKey] = vRiskDateKeyPrevious  )  VAR vFilteredFund =  ADDCOLUMNS (  FILTER (  FundItems,  ( FundItems[AssetClass] = "EQUITY"  || FundItems[AssetClass] = "FIXED INCOME" )  && ( FundItems[RiskVersionKey] = vRiskVersionKeyCurrent  || FundItems[RiskVersionKey] = vRiskVersionKeyPrevious )  && ( FundItems[PoolFundCode] <> "RISKNEUFR"  && FundItems[PoolFundCode] <> "RISKNEUST"  && FundItems[PoolFundCode] <> "RUMCA"  && FundItems[PoolFundCode] <> "E0D0125" )  && FundItems[IsCash] = "N"  && ( FundItems[RiskPortfolioCode] <> "CE6103"  && FundItems[RiskPortfolioCode] <> "ME170E"  && FundItems[RiskPortfolioCode] <> "ME170K"  && FundItems[RiskPortfolioCode] <> "ME170L"  && FundItems[RiskPortfolioCode] <> "ME170UIN"  && FundItems[RiskPortfolioCode] <> "ME0027"  && FundItems[RiskPortfolioCode] <> "ME173D" )  ),  "PoolFundName2", FIRSTNONBLANK ( FundItems[PoolFundName], 1 ),  "BlankValue", BLANK ()  )  RETURN  UNION (  CALCULATETABLE (  ADDCOLUMNS (  SUMMARIZE (  vFilteredFund,  [AssetClass],  [SubAssetClass],  [PoolFundName],  [RiskPortfolioCode],  [RiskPortfolioName]  ),  "MarketValueCurrent", CALCULATE ( [PV], riskversion[RiskVersionKey] = vRiskVersionKeyCurrent ),  "MarketValuePrevious", CALCULATE ( [PV], riskversion[RiskVersionKey] = vRiskVersionKeyPRevious ),  "PfActiveRiskPCt_Current", DIVIDE (  CALCULATE (  [StandaloneActiveHDVar],  ActiveBenchmark[BenchmarkType] = "Rollup",  riskversion[RiskVersionKey] = vRiskVersionKeyCurrent  ),  CALCULATE ( [PV], riskversion[RiskVersionKey] = vRiskVersionKeyCurrent )  ),  "PfActiveRiskPCt_Previous", DIVIDE (  CALCULATE (  [StandaloneActiveHDVar],  ActiveBenchmark[BenchmarkType] = "Rollup",  riskversion[RiskVersionKey] = vRiskVersionKeyPRevious  ),  CALCULATE ( [PV], riskversion[RiskVersionKey] = vRiskVersionKeyPRevious )  ),"PoolActiveHDVar_Current", DIVIDE (  CALCULATE (  [StandaloneActiveHDVar],  ActiveBenchmark[BenchmarkType] = "Rolldown",  riskversion[RiskVersionKey] = vRiskVersionKeyCurrent  ),  CALCULATE ( [PV], riskversion[RiskVersionKey] = vRiskVersionKeyCurrent ) ), "PoolActiveHDVar_Previous", DIVIDE (     CALCULATE (  [StandaloneActiveHDVar],  ActiveBenchmark[BenchmarkType] = "Rolldown",  riskversion[RiskVersionKey] = vRiskVersionKeyPRevious  ),  CALCULATE ( [PV], riskversion[RiskVersionKey] = vRiskVersionKeyPRevious ) ),  /* Here we need to override the filter context to get the Pooltotal to be the denominator */  "PoolContributionToActivePct_Current", DIVIDE (  CALCULATE (  [ContributionActiveHDVar],  ActiveBenchmark[BenchmarkType] = "Rolldown",  riskversion[RiskVersionKey] = vRiskVersionKeyCurrent,  FundItems[IsCash] = "N",  FundItems[IsAllocation] = "N",  varContributionBy[Variant] = "PoolFund"  ),  CALCULATE (  [ContributionActiveHDVar],  ActiveBenchmark[BenchmarkType] = "Rolldown",  riskversion[RiskVersionKey] = vRiskVersionKeyCurrent,  FundItems[IsCash] = "N",  FundItems[IsAllocation] = "N",  varContributionBy[Variant] = "PoolFund",  FILTER (  ALLSELECTED ( FundItems ),  [PoolFundName] = EARLIER ( [PoolFundName] )  )  )  ),  "PoolContributionToActivePct_Previous", DIVIDE (  CALCULATE (  [ContributionActiveHDVar],  ActiveBenchmark[BenchmarkType] = "Rolldown",  riskversion[RiskVersionKey] = vRiskVersionKeyPrevious,  FundItems[IsCash] = "N",  FundItems[IsAllocation] = "N",  varContributionBy[Variant] = "PoolFund"  ),  CALCULATE (  [ContributionActiveHDVar],  ActiveBenchmark[BenchmarkType] = "Rolldown",  riskversion[RiskVersionKey] = vRiskVersionKeyPrevious,  FundItems[IsCash] = "N",  FundItems[IsAllocation] = "N",  varContributionBy[Variant] = "PoolFund",  FILTER (  ALLSELECTED ( FundItems ),  [PoolFundName] = EARLIER ( [PoolFundName] )  )  )  ),  "PortfolioBmk", FIRSTNONBLANK ( fundItems[BmkCodeRollup], 1 ),  "PoolFundBmk", BLANK (),  "AggLevel", "Pf"  ),  varRiskType[VarRiskType] = "All Risks",  ShowValuesAs[ScaleName] = "Millions",  ShowVarSign[VarSign] = "Positive",  OR (  riskversion[RiskVersionKey] = vRiskVersionKeyPrevious,  riskversion[RiskVersionKey] = vRiskVersionKeyCurrent  ),  OR ( FundItems[AssetClass] = "EQUITY", FundItems[AssetClass] = "FIXED INCOME" )  ),  CALCULATETABLE (  ADDCOLUMNS (  SUMMARIZE (  vFilteredFund,  [AssetClass],  [SubAssetClass],  [PoolFundName],  [BlankValue],  [PoolFundname2]  ),  "MarketValueCurrent", SUMX (  VALUES ( FundItems[RiskPortfolioCode] ),  CALCULATE (  [PV],  riskversion[RiskVersionKey] = vRiskVersionKeyCurrent,  FundItems[IsCash] = "N",  ALL ( FundItems[IsAllocation] )  )  ),  "MarketValuePrevious", SUMX (  VALUES ( FundItems[RiskPortfolioCode] ),  CALCULATE (  [PV],  riskversion[RiskVersionKey] = vRiskVersionKeyPrevious,  FundItems[IsCash] = "N",ALL ( FundItems[IsAllocation] )  )  ),  /* At pool level need to sum portfolio var and then divide by sum of portfolioPV  */  "PfActiveRiskPct_Current", DIVIDE (  SUMX (  VALUES ( FundItems[RiskPortfolioCode] ),  CALCULATE (  [StandaloneActiveHDVar],  ActiveBenchmark[BenchmarkType] = "Rollup",  riskversion[RiskVersionKey] = vRiskVersionKeyCurrent,  FundItems[IsCash] = "N",  ALL ( FundItems[IsAllocation] )  )  ),  SUMX (  VALUES ( FundItems[RiskPortfolioCode] ),  CALCULATE (  [PV],  riskversion[RiskVersionKey] = vRiskVersionKeyCurrent,  FundItems[IsCash] = "N",  ALL ( FundItems[IsAllocation] )  )  )  ),  "PfActiveRiskPCt_Previous", DIVIDE (  SUMX (  VALUES ( FundItems[RiskPortfolioCode] ),  CALCULATE (  [StandaloneActiveHDVar],  ActiveBenchmark[BenchmarkType] = "Rollup",  riskversion[RiskVersionKey] = vRiskVersionKeyPrevious,  FundItems[IsCash] = "N",  ALL ( FundItems[IsAllocation] )  )  ),  SUMX (  VALUES ( FundItems[RiskPortfolioCode] ),  CALCULATE (  [PV],  riskversion[RiskVersionKey] = vRiskVersionKeyPrevious,  FundItems[IsCash] = "N",  ALL ( FundItems[IsAllocation] )  )  )  ),   "PoolActiveVarPct_Current", DIVIDE (  SUMX (  VALUES ( FundItems[RiskPortfolioCode] ),  CALCULATE (  [StandaloneActiveHDVar],  ActiveBenchmark[BenchmarkType] = "Rolldown",  riskversion[RiskVersionKey] = vRiskVersionKeyCurrent,  FundItems[IsCash] = "N",  ALL ( FundItems[IsAllocation] )  )  ),  SUMX (  VALUES ( FundItems[RiskPortfolioCode] ),  CALCULATE (  [PV],  riskversion[RiskVersionKey] = vRiskVersionKeyCurrent,  FundItems[IsCash] = "N",  ALL ( FundItems[IsAllocation] )  )  )  ),  "PoolActiveVarPct_Previous", DIVIDE (  SUMX (  VALUES ( FundItems[RiskPortfolioCode] ),  CALCULATE (  [StandaloneActiveHDVar],  ActiveBenchmark[BenchmarkType] = "Rolldown",  riskversion[RiskVersionKey] = vRiskVersionKeyPrevious,  FundItems[IsCash] = "N",  ALL ( FundItems[IsAllocation] )  )  ),  SUMX (  VALUES ( FundItems[RiskPortfolioCode] ),  CALCULATE (  [PV],  riskversion[RiskVersionKey] = vRiskVersionKeyPrevious,  FundItems[IsCash] = "N",  ALL ( FundItems[IsAllocation] )  )  )  ),  "PoolContributionToActivePct_Current", 1,  "PoolContributionToActivePct_Previous", 1,  "PortfolioBmk", BLANK (),  "PoolFundBmk", FIRSTNONBLANK ( fundItems[BmkCodeRolldown], 1 ),  "AggLevel", "Pool"  ),  varRiskType[VarRiskType] = "All Risks",  ShowValuesAs[ScaleName] = "Millions",  ShowVarSign[VarSign] = "Positive",  OR (  riskversion[RiskVersionKey] = vRiskVersionKeyPrevious,  riskversion[RiskVersionKey] = vRiskVersionKeyCurrent  ),  OR ( FundItems[AssetClass] = "EQUITY", FundItems[AssetClass] = "FIXED INCOME" )  )  )  ORDER BY  FundItems[AssetClass],  FundItems[SubAssetClass],  FundItems[PoolFundName],  FundItems[RiskPortfolioCode],  FundItems[RiskPortfolioName]';
    SET @SQL_Query = 'SELECT '+@Curr_Date+' as Curr_Date,'+@Prev_Date+' as Prev_Date,*  FROM  OPENQUERY('+@Server_Name+'_ASSET_RM,'+''''+@DAX_Query+''''+')';


--/*
--Print @SQL_Query
    ----SELECT @SQL_Query;
--*/

    EXEC (@SQL_Query);
END;